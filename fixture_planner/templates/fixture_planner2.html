{% extends "_root.html" %}

{% block content %}
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/fixture_planner.css' %}">
  <link rel="stylesheet" href="{% static 'css/loading_spinner.css' %}">

<h2>
    Fixture Difficult Rating
</h2>


<p>
    FDR key: &nbsp
    <span class="diff-introduction color-1">1</span>
    <span class="diff-introduction color-2">2</span>
    <span class="diff-introduction color-3">3</span>
    <span class="diff-introduction color-4">4</span>
    <span class="diff-introduction color-5">5</span>
</p>

<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){
    $('#button').click(function(e) {
        var start_gw = $("#start_gw2").val();
        var end_gw = $("#end_gw2").val();
        var combinations = $("#combinations").val();
        if (combinations == "FDR") {
            window.location.replace(window.location.hostname + "/fixture-planner/" + start_gw + "/" + end_gw + "/" + combinations);
        }
        if (combinations == "FDR-best") {
            var min_num_fixtures = $("#min_num_fixtures").val();
            window.location.replace(window.location.hostname + "/fixture-planner/" + start_gw + "/" + end_gw + "/" + combinations + "/" + min_num_fixtures);
        }
        if (combinations == "Rotation") {
            var teams_to_play =  $("#teams_to_play").val();
            var teams_to_check =  $("#teams_to_check").val();
            window.location.replace(window.location.hostname + "/fixture-planner/" + start_gw + "/" + end_gw + "/" + combinations + "/" + teams_to_play + "/" + teams_to_check);
        }
    });
});</script>
    <script>
function myFunction(argument) {
        window.location.replace("/fixture-planner/test");
}
</script>

<script>
function hide() {
  var x = document.getElementById("which_teams_to_check");
  if (x.style.display === "none") {
    x.style.display = "block";
  } else {
    x.style.display = "none";
  }
}
</script>

<script>
function hide2() {
  var x = document.getElementById("which_teams_to_check2");
  if (x.style.display === "none") {
    x.style.display = "block";
  } else {
    x.style.display = "none";
  }
}
</script>



<form class="text-center" action="/fixture-planner/" method="post">
    {% if combinations == "FDR" %}
    <input type="submit" class="category chosen-category" value="FDR" checked name="combination">
    {% else %}
    <input type="submit" class="category" value="FDR" name="combination">
    {% endif %}

    {% if combinations == "FDR-best" %}
    <input type="submit" class="category chosen-category" value="FDR-best" name="combination">
    {% else %}
    <input type="submit" class="category" value="FDR-best" name="combination">
    {% endif %}

    {% if combinations == "Rotation" %}
    <input type="submit" class="category chosen-category" value="Rotation" checked name="combination">
    {% else %}
    <input type="submit" class="category" value="Rotation" name="combination">
    {% endif %}
            {% csrf_token %}
    <input hidden class="box" type="number" min=1 max=38 value={{gw_start}} id="start_gw3" name="gw-info">
    <input hidden class="box" type="number" min=1 max=38 value={{gw_end}} id="end_gw3" name="gw-info">
    <input hidden type="text" value={{combinations}} id="combination2" name="combination">
    <input hidden class="box" type="number" min=1 max={{gws}} value={{min_num_fixtures}} id="min_num_fixtures2" name="min_num_fixtures">
    <input hidden type="number" min=1 max=5 value={{teams_to_check}} name="teams_to_check">
    <input hidden type="number" min=1 max=5 value={{teams_to_play}} name="teams_to_play">
    {% for team_name in team_name_list %}
             {% if forloop.counter|divisibleby:3 %}
                {% endif %}
                <input hidden type="checkbox" id="{{team_name.team_name}}-2" value="{{team_name.team_name}}" name="fpl-teams" checked>

            {% endfor %}
</form>



<div class="text-center">
    <form action="/fixture-planner/" method="post">
        GW start: &nbsp<input class="box" type="number" min=1 max=38 value={{gw_start}} id="start_gw2" name="gw-info">
        GW end: &nbsp<input class="box" type="number" min=1 max=38 value={{gw_end}} id="end_gw2" name="gw-info">

        {% if combinations == "FDR-best" %}
        <br>
        Minimum fixtures: &nbsp<input class="box" type="number" min=1 max={{gws}} value={{min_num_fixtures}} id="min_num_fixtures" name="min_num_fixtures">
        {% else %}
        <input hidden class="box" type="number" min=1 max=38 value={{min_num_fixtures}} name="min_num_fixtures">
        {% endif %}

        {% if combinations == "Rotation" %}
        <br>
        Teams to check: &nbsp<input class="box" type="number" min=1 max=5 value={{teams_to_check}} id="teams_to_check" name="teams_to_check">
        Teams to play: &nbsp<input class="box" type="number" min=1 max=5 value={{teams_to_play}} id="teams_to_play" name="teams_to_play">
        {% else %}
        <input hidden type="number" min=1 max=5 value={{teams_to_check}} name="teams_to_check">
        <input hidden type="number" min=1 max=5 value={{teams_to_play}} name="teams_to_play">
        {% endif %}

        <input hidden type="text" value={{combinations}} id="combination" name="combination">

        {% csrf_token %}
        <input class="update" type="submit" value="Search">
        <div id="which_teams_to_check">
            <div>
            {% for team_name in team_name_list %}
             {% if forloop.counter|divisibleby:3 %}
                </div>
                <div>
                {% endif %}
                <input type="checkbox" id="{{team_name.team_name}}" value="{{team_name.team_name}}" name="fpl-teams" {{team_name.checked}}>
                    {% if combinations == "Rotation" %}
                        <input class="solution-box" type="checkbox" id="{{team_name.team_name}}-in-solution" value="{{team_name.team_name}}" name="fpl-teams-in-solution" {{team_name.checked_must_be_in_solution}}>
                     {% endif %}
                <label for="{{team_name.team_name}}">{{team_name.team_name}}</label>
            {% endfor %}
                </div>
        </div>
    </form>
    <button class="margin-top-bottom" onclick="hide()">Include teams in solution &#x2193</button>
</div>


<!--div id="spinner-box" class="text-center mt-3">
    <div class="spinner-border text-primary" role="status"></div>
</div -->

<div id="spinner-box" class="boxs">
  <div class="shadow"></div>
  <div class="gravity">
    <div class="ball"></div>
  </div>
</div>

<div id="data-box" class="text-center mt-3"></div>

<script>
    const spinnerBox = document.getElementById('spinner-box')
    const dataBox = document.getElementById('data-box')

    var body = JSON.stringify({
                    number_of_teams: {{ number_of_teams }},
                    start_gw: {{ gw_start }},
                    end_gw: {{ gw_end }},
                    fpl_teams: {{ fpl_teams|safe }},
                    combinations: "{{ combinations }}",
                    min_num_fixtures: {{ min_num_fixtures }},
                    teams_to_check: {{ teams_to_check }},
                    teams_to_play: {{ teams_to_play }},
                    });

    {% if combinations == "FDR" or combinations == "FDR-best" %}

    $.ajax({
            url: '/fixture-planner/get-fdr-data/',
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            traditional: true,
            data: body,
            success: function(result) {
                spinnerBox.classList.add('not-visible');
                dataBox.innerHTML += `
                    <div class="container-fdr">
                        <div id="fdr-table" class="container-rotation">

                            <div id="fdr-team-names">
                                <table>
                                    <tbody id="fdr-names">
                                        <tr>
                                            <td class="name-column min-width">
                                                Name
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div id="fdr-team-difficulty">
                                <table>
                                    <tbody id="fdr-gws">
                                        <tr id="fdr-row-gws">
                                            {% for gw_number in gw_numbers %}
                                                <th class="min-width"> GW {{ gw_number.gameweek }}
                                                    <div class="day_month">
                                                        {{ gw_number.day_month }}
                                                    </div>
                                                </th>
                                            {% endfor %}
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                    `

                const tbodyBox = document.getElementById('fdr-names')
                const fdrTableBox = document.getElementById('fdr-gws')

                for (const rows of result.fdr_fixture_data){
                    for (const col of rows){
                        const myObj = JSON.parse(col);
                        tbodyBox.innerHTML += `
                            <tr>
                                <td class="name-column min-width">
                                    ${ myObj.team_name }
                                </td>
                            </tr>
                        `
                        fdrTableBox.innerHTML += `
                            <tr id="fdr-row-${myObj.team_name}"></tr>
                        `
                        break;
                    }
                }

                for (const rows of result.fdr_fixture_data){
                    for (const col of rows){
                        const myObj2 = JSON.parse(col);
                        var id_s = 'fdr-row-' + myObj2.team_name;
                        const ith_row = document.getElementById(id_s)
                        var html_string = "";
                        var num_teams = col.length;

                        if (num_teams == 1) {
                            html_string += `<td scope="col" class=" min-width color-${myObj2.difficulty_score}
                              double-border-${myObj2.Use_Not_Use}"
                            `
                        }
                        else {
                            html_string += `<td scope="col" class=" min-width no-padding double-border-${myObj2.Use_Not_Use}" `
                        }

                        for (const team in col){
                            html_string += `<div class=" min-width color-${myObj2.difficulty_score}
                            multiple-fixtures height-${num_teams}">`

                            if (myObj2.opponent_team_name == '-') {
                                html_string += `Blank`
                            }
                            else {
                                html_string += `${myObj2.opponent_team_name}&nbsp(${myObj2.H_A})`
                            }
                            html_string += `</div>`
                        }
                        html_string += `</td>`

                        ith_row.innerHTML += `
                            ${html_string}
                        `
                    }
                }
            },
            error: function(error){
                spinnerBox.classList.add('not-visible')
                console.log(error)
                dataBox.innerHTML += `<b>Error loading data</b><br><br>`
            }
        });

    {% endif %}

    {% if combinations == "Rotation" %}
        $.ajax({
            url: '/fixture-planner/get-rotation-data/',
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            traditional: true,
            data: body,
            success: function(result){
                spinnerBox.classList.add('not-visible')

                if (result.fdr_fixture_data[0][0] != "Wrong input") {
                    dataBox.innerHTML += `
                        <div class="big-container">
                            <div class="container-rotation">
                                <div>
                                    <div id="fdr-rotation">
                                    </div>
                                </div>
                            </div>
                        </div>
                     `

                    for (const row of result.fdr_fixture_data){
                        const ith_row = document.getElementById("fdr-rotation");

                        var html_string = `<table class="rotation">`;

                        html_string += `
                            <tbody>
                                <tr>
                                    <th class="name-col-rotation">
                                        Name
                                    </th>
                                    {% for gw_number in gw_numbers %}
                                        <th class="min-width"> GW {{ gw_number.gameweek }}
                                        </th>
                                    {% endfor %}
                                </tr>
                            `

                        for (const data of row[5]) {
                            html_string += `<tr>`;
                            var i = 0;
                            for (const data_i of data) {
                                var json_data = JSON.parse(data_i[0]);
                                if (i == 0) {
                                    html_string += `<td class="name-column min-width">
                                            ${json_data.team_name}
                                        </td>
                                    `
                                }

                                if (data_i.length == 1){
                                    html_string += `
                                        <td scope="col" class=" min-width color-${json_data.difficulty_score} double-border-${json_data.Use_Not_Use}">
                                    `
                                }

                                else {
                                    html_string += `
                                        <td scope="col" class=" min-width no-padding double-border-${json_data.Use_Not_Use}">
                                    `
                                }

                                for (const team of data_i){

                                    var num_teams = team.length;
                                    var json_team_data = JSON.parse(team);
                                    html_string += `
                                        <div class" min-width color-${json_team_data.difficulty_score}
                                         multiple-fixtures height-${num_teams}">
                                    `

                                    if (json_team_data.opponent_team_name == '-') {
                                        html_string += `Blank`
                                    }
                                    else {
                                        html_string += `${json_team_data.opponent_team_name}&nbsp(${json_team_data.H_A})`
                                    }
                                    html_string += `</div>`
                                }

                                html_string += `</td>`

                                i = i + 1;
                            }
                            html_string += `</tr>`;
                        }

                        html_string += `</table>`;
                        const num = row[0].toFixed(2);
                        html_string += `<p> Avg. FDR score: <b> ${num} </b>`;
                        ith_row.innerHTML += `
                            ${html_string}
                        `
                    }
                }

                else {
                    dataBox.innerHTML += ` <div style="text-align: center; font-weight: 800;">
                        <br>
                        Wrong Input
                    </div><br>`
                }
            },
            error: function(error){
                spinnerBox.classList.add('not-visible')
                console.log(error)
                dataBox.innerHTML += `<b>Error loading data</b><br><br>`
            }
        })
    {% endif %}

</script>

{% endblock content %}




